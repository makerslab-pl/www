# MakersLab - Makefile
# Komendy do zarzÄ…dzania projektem

.PHONY: help build up down restart logs shell test test-coverage lint clean

# DomyÅ›lna komenda
help:
	@echo "MakersLab - DostÄ™pne komendy:"
	@echo ""
	@echo "  Docker:"
	@echo "    make build       - Buduj obrazy Docker"
	@echo "    make up          - Uruchom kontenery"
	@echo "    make down        - Zatrzymaj kontenery"
	@echo "    make restart     - Restartuj kontenery"
	@echo "    make logs        - PokaÅ¼ logi"
	@echo "    make shell       - Shell w kontenerze app"
	@echo ""
	@echo "  Testy:"
	@echo "    make test        - Uruchom wszystkie testy"
	@echo "    make test-unit   - Uruchom testy jednostkowe"
	@echo "    make test-int    - Uruchom testy integracyjne"
	@echo "    make test-cov    - Testy z pokryciem kodu"
	@echo ""
	@echo "  JakoÅ›Ä‡ kodu:"
	@echo "    make lint        - SprawdÅº styl kodu (PSR-12)"
	@echo "    make lint-fix    - Napraw styl kodu"
	@echo "    make analyse     - Analiza statyczna (PHPStan)"
	@echo "    make check       - Wszystkie sprawdzenia"
	@echo ""
	@echo "  Inne:"
	@echo "    make install     - Zainstaluj zaleÅ¼noÅ›ci"
	@echo "    make clean       - WyczyÅ›Ä‡ pliki tymczasowe"
	@echo "    make backup      - Backup bazy danych"

# ==========================================
# DOCKER
# ==========================================

build:
	docker-compose build

up:
	docker-compose up -d
	@echo ""
	@echo "âœ… MakersLab uruchomiony!"
	@echo "   Strona:     http://localhost:8080"
	@echo "   Admin:      http://localhost:8080/admin.php"
	@echo "   Adminer:    http://localhost:8081 (jeÅ›li uruchomiony z --profile dev)"

up-dev:
	docker-compose --profile dev up -d
	@echo ""
	@echo "âœ… MakersLab (tryb dev) uruchomiony!"
	@echo "   Strona:     http://localhost:8080"
	@echo "   Admin:      http://localhost:8080/admin.php"
	@echo "   Adminer:    http://localhost:8081"

down:
	docker-compose down

restart: down up

logs:
	docker-compose logs -f

logs-app:
	docker-compose logs -f app

shell:
	docker-compose exec app bash

# ==========================================
# TESTY
# ==========================================

# Uruchom testy w kontenerze
test:
	docker-compose run --rm test

# Lub lokalnie (wymaga composer install)
test-local:
	./vendor/bin/phpunit --colors=always

test-unit:
	./vendor/bin/phpunit --testsuite=Unit --colors=always

test-int:
	./vendor/bin/phpunit --testsuite=Integration --colors=always

test-feature:
	./vendor/bin/phpunit --testsuite=Feature --colors=always

test-cov:
	XDEBUG_MODE=coverage ./vendor/bin/phpunit --coverage-html coverage --coverage-text
	@echo ""
	@echo "ðŸ“Š Raport pokrycia: coverage/index.html"

test-ci:
	./vendor/bin/phpunit --colors=always --log-junit test-results.xml

# ==========================================
# JAKOÅšÄ† KODU
# ==========================================

lint:
	./vendor/bin/phpcs --standard=PSR12 includes/ tests/

lint-fix:
	./vendor/bin/phpcbf --standard=PSR12 includes/ tests/

analyse:
	./vendor/bin/phpstan analyse includes/ tests/ --level=5

check: lint analyse test
	@echo ""
	@echo "âœ… Wszystkie sprawdzenia przeszÅ‚y pomyÅ›lnie!"

# ==========================================
# INSTALACJA
# ==========================================

install:
	composer install

install-prod:
	composer install --no-dev --optimize-autoloader

update:
	composer update

# ==========================================
# BACKUP & CLEAN
# ==========================================

backup:
	@mkdir -p backups
	@cp data/makerslab.db backups/makerslab_$(shell date +%Y%m%d_%H%M%S).db 2>/dev/null || echo "Brak bazy danych do backupu"
	@echo "âœ… Backup utworzony w katalogu backups/"

clean:
	rm -rf coverage/
	rm -rf .phpunit.cache/
	rm -f coverage.txt coverage.xml test-results.xml
	rm -rf vendor/
	@echo "âœ… Pliki tymczasowe usuniÄ™te"

clean-docker:
	docker-compose down -v --rmi local
	@echo "âœ… Kontenery i obrazy Docker usuniÄ™te"

# ==========================================
# DEVELOPMENT
# ==========================================

# Uruchom serwer PHP (bez Dockera)
serve:
	php -S localhost:8000

# Watch dla testÃ³w (wymaga fswatch lub inotifywait)
watch:
	@echo "ObserwujÄ™ zmiany w plikach..."
	@while true; do \
		fswatch -1 includes/ tests/ && make test-local; \
	done

# Generuj dokumentacjÄ™
docs:
	@echo "TODO: Dodaj generowanie dokumentacji"
